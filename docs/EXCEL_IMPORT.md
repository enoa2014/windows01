# Excel导入配置指南

## 概述

本文档详细说明Excel导入功能的配置要求、字段映射规则和故障排除方法。

## Excel文件格式要求

### 基本结构
- 支持多行表头格式（第1行：主分类，第2行：具体字段）
- 数据从第3行开始
- 支持中文表头和多种表头变体

### 标准表头示例

```
第1行: 序号 | 姓名 | 性别 | 入住时间 | 入住人 | 患儿基本信息 |     |     |         | 就诊情况 |         |         | 医疗情况 |         |         | 家庭基本情况 |                     |                     |         |        
第2行:     |      |      |          |       | 出生日期     | 籍贯 | 民族 | 身份证号 | 就诊医院 | 医院诊断 | 医生姓名 | 症状详情 | 医治过程 | 后续治疗安排 | 家庭地址     | 父亲姓名、电话、身份证号 | 母亲姓名、电话、身份证号 | 其他监护人 | 家庭经济
```

## 字段映射规则

### 优先级排序
字段映射按照以下优先级进行，更具体的模式优先匹配：

1. **诊断字段** (优先级最高)
   - 模式: `/医院诊断|诊断/`
   - 匹配: "医院诊断"、"诊断"

2. **医院字段**
   - 模式: `/就诊医院|^医院$/`
   - 匹配: "就诊医院"、"医院"（精确匹配）
   - 不匹配: "医院诊断"（避免冲突）

3. **患者姓名字段**
   - 模式: `/^姓名$|患者姓名|患儿姓名/`
   - 匹配: "姓名"（精确）、"患者姓名"、"患儿姓名"

### 完整字段映射表

| 字段类型 | 匹配模式 | 示例表头 |
|---------|---------|----------|
| sequence | `/序号/` | "序号" |
| name | `/^姓名$|患者姓名|患儿姓名/` | "姓名"、"患者姓名" |
| gender | `/性别/` | "性别" |
| birthDate | `/出生日期|出生年月/` | "出生日期" |
| hometown | `/籍贯/` | "籍贯" |
| ethnicity | `/民族/` | "民族" |
| checkInDate | `/入住时间|入住日期/` | "入住时间" |
| attendees | `/入住人/` | "入住人" |
| diagnosis | `/医院诊断|诊断/` | "医院诊断"、"诊断" |
| hospital | `/就诊医院|^医院$/` | "就诊医院"、"医院" |
| doctorName | `/医生姓名|主治医生/` | "医生姓名" |
| symptoms | `/症状详情|症状/` | "症状详情" |
| treatmentProcess | `/医治过程|治疗过程/` | "医治过程" |
| followUpPlan | `/后续治疗安排|后续安排/` | "后续治疗安排" |
| homeAddress | `/家庭地址|地址/` | "家庭地址" |
| fatherInfo | `/父亲姓名、电话、身份证号|父亲.*姓名|父亲.*信息|父亲/` | "父亲姓名、电话、身份证号" |
| motherInfo | `/母亲姓名、电话、身份证号|母亲.*姓名|母亲.*信息|母亲/` | "母亲姓名、电话、身份证号" |
| otherGuardian | `/其他监护人/` | "其他监护人" |
| economicStatus | `/家庭经济/` | "家庭经济" |
| idCard | `/^身份证号$|^身份证$/` | "身份证号" |

## 数据验证规则

### 必填字段
- **姓名**: 必须提供，为空的记录将被跳过

### 数据格式
- **日期格式**: 支持 `YYYY.M.D`、`YYYY-M-D`、`YYYY/M/D`、`YYYY年M月D日`
- **身份证号**: 15或18位数字，最后一位可以是X
- **手机号**: 11位数字，以1开头

### 父母信息解析
格式: `姓名 电话 身份证号`（用空格分隔）
- 自动识别手机号格式 (1xxxxxxxxx)
- 自动识别身份证号格式 (15/18位)
- 其余部分作为姓名

## 故障排除

### 字段映射问题

**问题**: 就诊医院显示了诊断内容
**原因**: 早期版本字段映射存在优先级冲突
**解决**: 已修复，诊断字段优先匹配，医院字段更精确

**问题**: 某些字段映射不正确
**解决步骤**:
1. 检查Excel表头是否包含关键词
2. 查看导入日志中的字段映射结果
3. 必要时调整Excel表头格式

### 导入失败

**问题**: Excel文件读取失败
**检查项**:
- 文件是否正在被其他程序打开
- 文件格式是否为.xlsx
- 文件是否损坏

**问题**: 数据解析错误
**检查项**:
- 表头行是否正确（第1-2行）
- 数据行是否从第3行开始
- 是否有空行或格式异常

### 数据库问题

**问题**: 表不存在错误
**解决**: 运行 `node clean-database.js` 重新初始化

**问题**: 重复数据
**说明**: 系统会自动根据姓名和身份证号进行去重，相同人员的记录会被合并

## 技术实现

### 核心文件
- `src/services/ExcelImporter.js`: Excel解析和字段映射逻辑
- `src/database/DatabaseManager.js`: 数据库操作和去重逻辑
- `database-schema.sql`: 数据库表结构定义

### 字段映射算法
1. 读取Excel前两行作为表头
2. 合并表头内容创建完整字段名
3. 按优先级顺序匹配字段模式
4. 创建列索引到字段名的映射表
5. 根据映射表解析每行数据
 
### 数据处理流程
1. Excel文件读取 → 原始数据数组
2. 表头分析 → 字段映射表
3. 数据行解析 → 结构化记录
4. 数据库写入 → 自动去重和关联

---

## 关怀服务（受益人）导入

该模块将“关怀/志愿活动”的受益人与志愿服务数据导入到表 `care_beneficiary_records`，供关怀服务列表、详情与统计使用。

### 工作表与起始行
- 默认工作表：`Sheet1`
- 行约定：前 4 行可用于标题/说明，数据从第 5 行开始读取（即 Excel 第 5 行）。
- 汇总行：若“序号”列为“总合计”，该行会被忽略。

### 数据有效性（导入判定）
满足任一条件即视为有效记录，才会写入数据库：
- 有活动信息（活动名称或服务中心）
- 有受益人数据（成人/儿童人数之和 > 0）
- 有志愿者数据（志愿者人次或服务时长 > 0）

### 字段与建议表头
下表给出字段含义与建议的表头。若表头不同也可导入（按列位置读取），建议尽量遵循命名，便于后续维护。

- 基础信息
  - 序号：`sequence_number`
  - 年份：`year`
  - 月份：`month`
  - 服务中心：`service_center`
  - 项目领域：`project_domain`（如“主题活动/医疗协助/日常陪伴/个案关怀”）
  - 活动类型：`activity_type`
  - 活动日期：`activity_date`（支持 Excel 序列号与标准日期字符串，入库格式为 `YYYY-MM-DD`）
  - 活动名称：`activity_name`
  - 受益群体：`beneficiary_group`
  - 报告人：`reporter`
  - 报告日期：`report_date`（入库格式 `YYYY-MM-DD`）

- 受益人数据
  - 成人男：`adult_male`
  - 成人女：`adult_female`
  - 成人合计：`adult_total`
  - 儿童男：`child_male`
  - 儿童女：`child_female`
  - 儿童合计：`child_total`
  - 受益人次合计：`total_beneficiaries`

- 志愿服务数据（人次/小时）
  - 儿童志愿者：`volunteer_child_count` / `volunteer_child_hours`
  - 家长志愿者：`volunteer_parent_count` / `volunteer_parent_hours`
  - 学生志愿者：`volunteer_student_count` / `volunteer_student_hours`
  - 教师志愿者：`volunteer_teacher_count` / `volunteer_teacher_hours`
  - 社会志愿者：`volunteer_social_count` / `volunteer_social_hours`
  - 志愿者总计：`volunteer_total_count` / `volunteer_total_hours`

- 受益次数（去重口径可按业务定义）
  - 成人：`benefit_adult_times`
  - 儿童：`benefit_child_times`
  - 合计：`benefit_total_times`

- 备注
  - `notes`

### 数值与日期解析规则
- 空值、空字符串 → 记为 0（数值字段）或 NULL（日期）
- 数值：按 `parseFloat` 解析；无法解析记为 0
- 日期：支持 Excel 序列号与常见日期字符串；入库格式统一为 `YYYY-MM-DD`

### 示例表头（推荐）
```
序号 | 年 | 月 | 服务中心 | 项目领域 | 活动类型 | 活动日期 | 活动名称 | 受益群体 | 报告人 | 报告日期 | 成人男 | 成人女 | 成人合计 | 儿童男 | 儿童女 | 儿童合计 | 受益人次 | 儿童志愿者(人次) | 儿童志愿者(小时) | 家长志愿者(人次) | 家长志愿者(小时) | 学生志愿者(人次) | 学生志愿者(小时) | 教师志愿者(人次) | 教师志愿者(小时) | 社会志愿者(人次) | 社会志愿者(小时) | 志愿者总计(人次) | 志愿者总计(小时) | 受益次数(成人) | 受益次数(儿童) | 受益次数(合计) | 备注
```

### 入库表
- `care_beneficiary_records`（详见 `docs/DATABASE.md`）

### 导入入口
- 在“关怀服务列表”页面点击“导入Excel”，由前端调用 `electronAPI.careService.importExcel()` 触发。
