# 患儿入住信息管理系统

一个基于 Electron 的 Windows 桌面应用，用于管理小家患儿入住信息。

## 功能特性

### 📊 数据管理
- ✅ **数据导入**：支持从 Excel 文件导入患儿信息
- ✅ **智能去重**：根据姓名和身份证号自动识别同一人员
- ✅ **列表展示**：合并显示同一人员的多次入住记录
- ✅ **数据搜索**：支持按姓名、诊断、籍贯搜索
- ✅ **本地存储**：使用 SQLite 数据库本地存储

### 📈 统计分析
- ✅ **数据统计分析**：完整的统计分析仪表板
  - 患者概览统计（总数、平均年龄、多次入住）
  - 性别分布可视化
  - 地区分布统计
  - 疾病分布分析
  - 医生工作量统计
  - 年龄分布详细分析（支持交互式查看）
  - 入住趋势分析（月度趋势图表）

### 🎨 用户界面
- ✅ **详情查看**：查看完整的患儿档案和入住历史
- ✅ **医疗信息显示**：在详情页显示就诊医院、医院诊断、医生姓名等医疗信息
- ✅ **双视图模式**：列表视图和网格视图无缝切换（列表为默认）
- ✅ **响应式设计**：适配桌面端和移动端设备
- ✅ **多主题**：支持多种界面主题
- ✅ **现代化UI**：基于Material Design 3的设计系统
- ✅ **微动画效果**：流畅的用户交互体验
- ✅ **智能导航**：支持导航历史和模态框上下文保存
- ✅ **打印导出**：支持打印和导出功能

## 技术架构

- **前端框架**：Electron + HTML + CSS + JavaScript
- **数据库**：SQLite3
- **UI框架**：TailwindCSS + 自定义CSS变量主题系统
- **数据可视化**：Chart.js 图表库
- **Excel处理**：XLSX 库
- **构建工具**：Electron Builder

## 快速开始

### 环境要求

- Node.js 16.0 或更高版本
- Windows 7 或更高版本

### 安装依赖

```bash
npm install
```

### 开发模式运行

```bash
npm run dev
```

### 生产模式运行

```bash
npm start
```

### 打包构建

```bash
# 构建 Windows 版本
npm run build-win

# 构建所有平台版本
npm run build
```

## 项目结构

```
app02/
├── src/
│   ├── main.js                 # Electron 主进程
│   ├── preload.js             # 预加载脚本
│   ├── database/
│   │   └── DatabaseManager.js # 数据库管理
│   ├── services/
│   │   └── ExcelImporter.js   # Excel 导入服务
│   └── renderer/
│       ├── index.html         # 主界面
│       ├── js/
│       │   └── app.js         # 前端应用逻辑
│       └── styles/            # 样式文件系统
│           ├── enhanced-design-system.css  # 设计系统核心
│           ├── patient-card.css           # 患者卡片组件
│           ├── patient-detail.css         # 详情页样式
│           ├── animations.css             # 动画系统
│           └── responsive.css             # 响应式设计
├── docs/                      # 项目文档
│   ├── ui-optimization-implementation.md  # UI优化实施文档
│   └── view-mode-api.md                  # 视图模式API文档
├── ui_optimization_plan.md    # UI优化方案
├── database-schema.sql        # 数据库架构
├── package.json              # 项目配置
└── README.md                 # 项目说明
```

## 数据格式要求

Excel 文件应包含以下列（支持中文表头）：

### 基本信息
- **序号**、**姓名**、**性别**、**出生日期**、**籍贯**、**民族**、**身份证号**

### 入住信息
- **入住时间**、**入住人**

### 医疗信息
- **就诊医院**：医院名称（如：区人民医院、医科大学附属医院）
- **医院诊断**：疾病诊断（如：急性淋巴细胞白血病、白血病M4）
- **医生姓名**、**症状详情**、**医治过程**、**后续治疗安排**

### 家庭信息
- **家庭地址**、**父亲信息**、**母亲信息**、**其他监护人**、**家庭经济**

### 重要说明
- 字段映射支持灵活表头识别
- 系统会自动区分"就诊医院"和"医院诊断"两个独立字段
- 支持多行表头格式（第一行主分类，第二行具体字段）

## 人员去重规则

1. **不同身份证号**：算不同人员
2. **同名（无论是否有身份证）**：算同一人员
3. **智能补充**：同名人员后续提供身份证时，系统自动更新现有记录

## 使用说明

### 基本操作
1. **数据导入**：点击顶部"导入Excel"按钮选择数据文件
2. **查看列表**：在主界面浏览所有患儿信息
3. **视图切换**：使用右上角按钮在列表视图和网格视图间切换
4. **搜索筛选**：使用搜索框或筛选器查找特定患儿
5. **查看详情**：点击患儿卡片查看详细信息和入住历史
6. **医疗信息**：在详情页的入住记录卡片中查看医疗信息（就诊医院、医院诊断、医生姓名等）
7. **打印导出**：在详情页可打印或导出患儿档案

### 统计分析功能
8. **统计分析**：点击导航栏"数据统计分析"查看全面的数据分析
   - 查看患者总数、平均年龄、多次入住统计
   - 浏览性别、地区、疾病、医生的分布图表
   - 点击年龄组卡片查看该年龄段的具体患者列表
   - 查看月度入住趋势变化（需要有近期数据）
9. **交互式图表**：在年龄分布区域点击年龄段可查看具体患者
10. **导航历史**：系统会记住您的浏览路径，支持智能返回

### 视图模式说明

- **列表视图**（默认）：紧凑布局，信息密度高，适合快速浏览大量数据
- **网格视图**：卡片式布局，视觉友好，适合详细查看患儿信息
- 视图偏好自动保存，下次打开应用时恢复上次设置

## 快捷键

- `/` - 快速聚焦搜索框
- `F` - 聚焦性别筛选器
- `Enter/Space` - 打开选中的患儿详情

## 开发说明

### 主要模块

1. **DatabaseManager**：数据库操作和人员去重逻辑
2. **ExcelImporter**：Excel 文件解析和数据导入
3. **PatientApp**：前端应用主类，处理UI交互和数据展示

### 添加新功能

1. 在对应的服务类中添加业务逻辑
2. 在 `main.js` 中注册 IPC 处理器
3. 在 `preload.js` 中暴露安全的API
4. 在 `app.js` 中添加前端交互逻辑

### 数据库管理

- **数据库位置**：`%USERPROFILE%\AppData\Roaming\patient-checkin-manager\patients.db`
- **清理重置**：运行 `node clean-database.js` 清理数据库（会自动备份）
- **架构文件**：`database-schema.sql` 定义数据库结构

### Excel 字段映射

系统支持智能字段映射，按优先级匹配：
- **就诊医院**：匹配 `/就诊医院|^医院$/`
- **医院诊断**：匹配 `/医院诊断|诊断/`（优先级高于医院字段）
- **患者姓名**：匹配 `/^姓名$|患者姓名|患儿姓名/`

如果遇到字段映射问题，检查Excel表头是否符合上述模式。

## 许可证

MIT License

## 故障排除

### 常见问题

**Q: 列表页没有数据显示**
A: 检查是否已导入Excel文件，数据库可能为空

**Q: 就诊医院显示了诊断内容**
A: 这是字段映射冲突问题，系统已修复。重新导入Excel文件即可

**Q: 医疗信息没有显示**
A: 确保Excel文件包含医疗相关列，且数据不为空

**Q: 数据库初始化失败**
A: 运行 `node clean-database.js` 重新初始化数据库

### 数据库问题诊断

```bash
# 检查数据库状态
node -e "const db = require('./src/database/DatabaseManager'); (async()=>{const dbm = new db(); await dbm.initialize(); console.log(await dbm.getStatistics()); await dbm.close()})()"

# 清理并重新初始化数据库
node clean-database.js
```

## 更新日志

### v1.3.0 (2025-08-21)
- ✅ **统计分析功能**：新增完整的数据统计分析页面
  - 患者概览统计（总数、平均年龄、多次入住）
  - 性别分布饼图
  - 地区分布柱状图
  - 疾病分布统计图表
  - 医生工作量统计图表
  - 年龄分布详细分析（支持点击查看具体患者）
  - 入住趋势分析（最近12个月）
- ✅ **导航系统优化**：实现智能导航历史管理
  - 修复年龄组患者详情页导航问题
  - 实现模态框上下文保存
  - 优化返回按钮逻辑
- ✅ **数据准确性修复**：修复关键数据显示错误
  - 修复年龄组患者入住次数显示问题（SQL查询歧义）
  - 优化统计卡片文字可见性
  - 完善图表数据验证
- ✅ **系统稳定性改进**：解决Electron缓存权限问题
  - 添加自定义缓存路径配置
  - 禁用GPU沙盒避免权限冲突
  - 优化Windows系统兼容性

### v1.2.0 (2025-01-21)
- ✅ 完成全面UI优化，实现现代化设计系统
- ✅ 添加双视图模式（列表视图/网格视图），列表为默认
- ✅ 实现完整响应式设计，支持多设备适配
- ✅ 集成流畅的微动画系统
- ✅ 优化患者状态显示（显示入住次数而非出院状态）
- ✅ 改进年龄显示逻辑（无效年龄显示"未知"）
- ✅ 添加视图偏好持久化存储

### v1.1.0 (2025-08-20)
- ✅ 修复字段映射优先级冲突问题
- ✅ 改进数据库初始化流程
- ✅ 增强医疗信息显示功能
- ✅ 优化Excel导入字段识别

## 支持

如有问题或建议，请提交 Issue 或联系开发团队。