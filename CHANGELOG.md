# 更新日志

本文档记录患儿入住信息管理系统的版本更新和重要修复。

## [v1.1.0] - 2025-08-20

### 🔧 重要修复

#### 字段映射优先级冲突修复
- **问题**: 就诊医院字段显示了医院诊断的内容
- **根因**: ExcelImporter.js 中字段映射模式存在冲突，`/就诊医院|医院/` 会匹配到"医院诊断"
- **修复**: 
  - 调整字段映射优先级，诊断字段优先匹配
  - 改进医院字段模式为 `/就诊医院|^医院$/`，精确匹配避免冲突
- **文件**: `src/services/ExcelImporter.js:125-126`

#### 数据库初始化流程改进
- **问题**: 表创建和索引创建顺序导致的初始化错误
- **修复**: 分离表创建和索引创建步骤，确保表先创建再创建索引
- **文件**: `src/database/DatabaseManager.js:47-100`

### ✨ 功能增强

#### 医疗信息显示优化
- **新增**: 在患者详情页的入住信息卡片中显示医疗信息
- **字段**: 就诊医院、医生姓名、医院诊断、症状详情、医治过程、后续治疗安排、记录日期
- **特性**: 只有当字段有数据时才显示对应标签和内容
- **文件**: `src/renderer/js/app.js:394-450`

#### Excel导入诊断增强
- **改进**: 增强Excel结构分析和字段映射诊断
- **特性**: 详细的表头检测和字段映射日志
- **调试**: 数据行解析过程可视化
- **文件**: `src/services/ExcelImporter.js`

### 🗃️ 数据库变更

#### 医疗信息表优化
- **hospital字段**: 现在正确存储医院名称（如：区人民医院、医科大学附属医院）
- **diagnosis字段**: 正确存储诊断信息（如：急性淋巴细胞白血病、白血病M4）
- **数据分离**: 确保医院和诊断信息正确分离存储

### 🛠️ 技术改进

#### 数据库管理增强
- **架构解析**: 改进SQL语句解析，支持多行CREATE TABLE语句
- **错误处理**: 优化数据库初始化错误处理
- **清理脚本**: 完善数据库清理和备份机制

### 📋 验证结果

#### 导入测试
- **测试文件**: b.xlsx (243条记录)
- **导入结果**: 100% 成功 (imported: 243, skipped: 0, errors: [])
- **数据验证**: 医院和诊断字段正确分离存储

#### 功能验证
- ✅ 字段映射正确识别医院和诊断
- ✅ 数据库初始化无错误
- ✅ 医疗信息在详情页正确显示
- ✅ 去重逻辑正常工作

---

## [v1.0.0] - 2025-08-19

### 🎉 初始发布

#### 核心功能
- ✅ Excel数据导入
- ✅ 智能人员去重
- ✅ 患者列表展示
- ✅ 详细信息查看
- ✅ 数据搜索功能
- ✅ 本地SQLite存储
- ✅ 多主题界面
- ✅ 打印导出功能

#### 技术架构
- Electron + HTML + CSS + JavaScript
- SQLite3 数据库
- TailwindCSS + 自定义主题系统
- XLSX Excel处理库

---

## 升级指南

### 从 v1.0.0 升级到 v1.1.0

1. **备份数据** (自动完成)
   ```bash
   # 清理脚本会自动创建备份
   node clean-database.js
   ```

2. **更新代码**
   - 拉取最新代码
   - 运行 `npm install` 更新依赖

3. **重新导入数据**
   - 使用应用界面的Excel导入功能
   - 验证医院和诊断字段显示正确

### 数据迁移说明

由于字段映射逻辑的重大修复，建议重新导入Excel数据以确保：
- 医院字段存储正确的医院名称
- 诊断字段存储正确的诊断信息
- 医疗信息在详情页正确显示

旧数据备份会保留在：
`%USERPROFILE%\AppData\Roaming\patient-checkin-manager\patients_backup_*.db`

---

## 兼容性说明

- **Excel格式**: 支持.xlsx格式，多行表头结构
- **操作系统**: Windows 7及以上版本
- **Node.js**: 16.0及以上版本
- **数据库**: SQLite 3.x

## 技术支持

如遇到升级或使用问题，请：
1. 查看故障排除文档 (`docs/EXCEL_IMPORT.md`)
2. 检查数据库架构说明 (`docs/DATABASE.md`)
3. 联系开发团队获取支持