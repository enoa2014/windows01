# windows01 开发文档（新增页面指南）v0.1

> 适用范围：本仓库 enoa2014/windows01；用于理解现有架构，并在其基础上**快速新增一个功能页面**（例如“家庭服务列表”）。

---

## 1. 项目概览
- **定位**：基于 Electron 的 Windows 桌面应用，用于管理“小家”患儿入住与拓展业务数据。
- **核心能力**：Excel 导入 → 去重清洗 → 本地 SQLite 持久化 → 列表/网格展示 → 统计分析（Chart.js）。
- **主要技术栈**：Electron（主/渲染/预加载）、原生 HTML/CSS/JS、TailwindCSS、自定义主题、SQLite3、XLSX、Chart.js、Electron Builder。

> 参考：仓库根目录包含 `src/`（主代码）、`database-schema.sql`（数据库结构）、`docs/`（文档）、若干 Demo/测试脚本与页面原型（如 `入住信息列表.html`、`main-page-demo.html`）等。

---

## 2. 运行与打包
- **开发**：`npm run dev`
- **生产**：`npm start`
- **打包**：`npm run build-win`（Windows）或 `npm run build`

> 建议安装 Node.js ≥ 16；首次运行前 `npm install`。

---

## 3. 目录结构与职责
> 以下为 README 与文件清单反映的关键结构，路径名以 `src/` 为主。

```
src/
  main.js                # Electron 主进程入口（BrowserWindow、菜单、IPC 注册、权限、安全策略）
  preload.js             # 预加载脚本（通过 contextBridge 暴露安全 API 到渲染层）
  database/              # 数据访问层
    DatabaseManager.js   # SQLite 连接、建表/迁移、查询、写入、去重逻辑
  services/
    ExcelImporter.js     # Excel 解析与字段映射、清洗、批量入库
  renderer/
    index.html           # 应用主界面（承载导航/容器）
    js/
      app.js            # 页面装配/事件交互（页面切换、IPC 调用、渲染视图）
    styles/
      enhanced-design-system.css  # 主题与设计系统变量
      patient-card.css
      patient-detail.css
      animations.css
      responsive.css
```

**仓库其他文件**（与开发相关）：
- `database-schema.sql`：数据库表结构定义（患者、入住记录等）。
- `docs/`：UI 优化与视图模式相关文档。
- 原型/测试：`入住信息列表.html`、`main-page-demo.html`、`test-*.js`、`start-family-service.js` 等。

---

## 4. 进程与数据流
```
Excel → ExcelImporter（解析/映射/清洗） → DatabaseManager（SQLite 持久化） →
主进程（IPC handler） ←→ 预加载（contextBridge 暴露 API） ←→ 渲染层 app.js（UI/交互/渲染）
```
- **IPC 通道建议**（命名规范）：`domain:action`（如 `patient:list`、`stats:get`、`excel:import`）。
- **最小权限原则**：所有文件读写、DB 操作都在主进程；渲染层只通过预加载暴露的 API 访问。

---

## 5. 数据库与字段映射
- **DB 文件位置**：位于用户数据目录（如 `%APPDATA%/patient-checkin-manager/patients.db`）。
- **实体建议**：
  - `patients`（患者主体：姓名、性别、身份证、出生日期、籍贯等）
  - `checkins`（入住记录：患者ID、入住时间、入住人/陪护、就诊医院、医院诊断、医生姓名等）
  - 可选维度表：`hospitals`、`diagnoses`、`doctors`（如需规范化）。
- **Excel 字段映射**：支持中文表头多样式，优先匹配“就诊医院”“医院诊断”等关键字段，避免互相覆盖。

> 具体表结构与约束以 `database-schema.sql` 为准；新增页面如需新统计口径，优先通过 **视图/查询** 实现，必要时再演进表结构与迁移脚本。

---

## 6. UI/主题与视图模式
- **主题**：通过 CSS 变量 + Tailwind 自定义配置（`enhanced-design-system.css`）。
- **视图**：列表（默认）/网格切换；导航历史与模态上下文保持；适配桌面端。
- **可视化**：Chart.js 构建概览卡片、分布图、趋势图，交互点击可回钻到明细列表。

---

## 7. 新增页面的整体思路
> 以新增“**家庭服务列表**（Family Services）”为例；同理可扩展到其他业务页面。

### 7.1 新页面能力清单（推荐）
- 顶部工具条：搜索（关键字/家乡/诊断）、筛选（时间范围/医院/服务类型）、视图切换（列表/网格）。
- 主体区域：
  - 列表：高密度行 + 关键字段（姓名、最近入住、医院、诊断、服务记录数）。
  - 网格：卡片（头像/首字母、标签、最近动态）。
- 交互：分页/增量加载（懒加载）、空态引导（导入数据/新建记录）。
- 明细抽屉/弹窗：展示家庭画像与服务记录时间轴。

### 7.2 文件放置与命名
```
src/renderer/pages/family-services/
  index.html       # 可选：独立子页面，或复用主 index.html 的一个 <section>
  family-services.js
  family-services.css
```
> 若项目采用单页（`renderer/index.html`），建议在其中新增一个 `<section id="page-family-services">`，并由 `app.js` 负责“页面切换”。

### 7.3 导航集成
- 在主导航（侧边栏/顶部菜单）新增入口：`data-route="family-services"`。
- 在 `app.js` 的路由/切换函数中注册：
  - Hash 路由（如 `#family-services`），或
  - 自定义事件总线（在点击时触发 `showPage('family-services')`）。

### 7.4 IPC + 数据访问（示例约定）
1) **preload.js** 暴露 API（示例）：
```js
// preload.js（示例片段）
const { contextBridge, ipcRenderer } = require('electron');
contextBridge.exposeInMainWorld('api', {
  familyService: {
    list: (params) => ipcRenderer.invoke('family:list', params),
    stats: (params) => ipcRenderer.invoke('family:stats', params)
  },
  patients: {
    getById: (id) => ipcRenderer.invoke('patient:getById', id)
  }
});
```

2) **main.js** 注册 handler（示例）：
```js
// main.js（示例片段）
const { ipcMain } = require('electron');
const db = require('./database/DatabaseManager');
const database = new db();

ipcMain.handle('family:list', async (_evt, params) => {
  // TODO: 根据 params（keyword, hospitalId, dateRange, page, pageSize）查询
  return database.queryFamilyServices(params);
});

ipcMain.handle('family:stats', async (_evt, params) => {
  return database.queryFamilyServiceStats(params);
});
```

3) **DatabaseManager.js** 添加查询方法（示例）：
```js
// database/DatabaseManager.js（示例片段）
class DatabaseManager {
  /* ...init/close... */
  async queryFamilyServices({ keyword, hospitalId, dateRange, page=1, pageSize=50 }) {
    // 组合 SQL：WHERE + LIMIT/OFFSET；对 keyword 做 LIKE 模糊匹配；必要时建立索引
    // 返回 { items, total }
  }
  async queryFamilyServiceStats(params) {
    // 汇总统计：按医院/月份/服务类型分组计数
  }
}
module.exports = DatabaseManager;
```

4) **渲染层** `family-services.js`：
```js
// 渲染层示例
const state = { page: 1, pageSize: 50, keyword: '', viewMode: 'list' };

async function loadData() {
  const { items, total } = await window.api.familyService.list({
    keyword: state.keyword,
    page: state.page,
    pageSize: state.pageSize
  });
  renderList(items);  // 或 renderGrid(items)
  renderPager(total);
}

document.querySelector('#fs-search').addEventListener('input', (e)=>{
  state.keyword = e.target.value.trim();
  state.page = 1; loadData();
});

document.querySelector('#fs-toggle-view').addEventListener('click', ()=>{
  state.viewMode = state.viewMode === 'list' ? 'grid' : 'list';
  document.body.dataset.view = state.viewMode; // 用于切换样式
});

// 首次进入页面
loadData();
```

### 7.5 UI 模板（片段）
```html
<!-- index.html 中的一个 section 作为新页面容器 -->
<section id="page-family-services" hidden>
  <header class="flex items-center gap-3 p-3 border-b">
    <input id="fs-search" class="input" placeholder="搜索姓名/诊断/籍贯…" />
    <button id="fs-toggle-view" class="btn">切换视图</button>
  </header>
  <div id="fs-content" class="p-3">
    <!-- 列表/网格渲染到此 -->
  </div>
</section>
```

### 7.6 懒加载与性能
- 大列表建议：
  - **分页** + “加载更多”（减少首屏时间）；
  - 滚动触底触发下一页；
  - 头像/图片使用 IntersectionObserver 懒加载；
  - 对高频筛选条件建立索引（如 `patients(name)`、`checkins(admit_date)`）。
- Chart.js 图表按需挂载（进入可见区域时再初始化）。

### 7.7 安全与权限
- 禁止在渲染层直接使用 `require('fs')/sqlite3`；一律走 IPC。
- 预加载仅暴露必要函数，**校验参数类型**，避免任意 SQL/路径注入。
- 启用 `contextIsolation`、`sandbox`（按 Electron 支持情况），设置 `Content-Security-Policy`。

---

## 8. 统计分析页面复用建议
- 新页面若需要统计卡片与分布图：
  - 封装 `useChart(el, options)` 工具，统一注册/销毁；
  - 统一配色与字号，保持与“数据统计分析”页一致；
  - 提供“点击分组回钻到明细列表”的回调协议（约定 `onSelect(group)`）。

---

## 9. 代码风格与规范
- **命名**：`lowerCamelCase`（JS）、`kebab-case`（文件/类名可统一一种风格即可）。
- **通道**：`domain:action`；查询 `:list/:get/:stats`，修改 `:create/:update/:remove`。
- **UI 类名**：以组件为前缀，如 `.fs-card`、`.fs-toolbar`。
- **数据类型**：统一一个轻量 `types.js` 或 JSDoc 注释声明字段（姓名/身份证/诊断等）。
- **错误处理**：IPC handler 用 `try/catch` 返回 `{ ok:false, error }`；渲染层 toast。

---

## 10. 测试与验收清单（建议）
- [ ] 无数据空态：展示导入引导与“新建”按钮
- [ ] 搜索/筛选：关键字、日期范围、医院、服务类型
- [ ] 视图切换：列表 ↔ 网格，状态持久化（localStorage）
- [ ] 分页/懒加载：翻页正确、性能平稳
- [ ] 明细弹窗：字段完整（姓名/医院/诊断/医生/服务）
- [ ] 导出/打印：版式正确、分页控制
- [ ] 刷新与导航历史：返回后恢复上下文
- [ ] 安全：渲染层无敏感 Node 能力；IPC 参数校验

---

## 11. 常见问题（结合现有项目特性）
- **列表页无数据**：优先确认是否导入了 Excel；字段映射是否命中；数据库初始化是否成功。
- **医院/诊断混淆**：检查 Excel 表头，确保“就诊医院”与“医院诊断”分列；必要时调整映射正则。
- **统计不一致**：对 SQL 聚合增加显式别名与去重逻辑；统一日期归一（到日/月）。

---

## 12. 新页面落地“脚手架”任务
1. 新建 `src/renderer/pages/family-services/` 三件套（HTML/JS/CSS）。
2. 在 `index.html` 注册 `<section id="page-family-services">`；导航加入按钮。
3. 在 `app.js` 中：实现 `showPage('family-services')` 与事件绑定。
4. 在 `preload.js` 暴露 `window.api.familyService.list/stats`。
5. 在 `main.js` 注册 `ipcMain.handle('family:*')`；在 `DatabaseManager` 实现查询。
6. 新增必要索引/视图（如按月份聚合）并在迁移脚本中维护。
7. 自测与回归；补充 `docs/` 下页面说明与截图。

---

## 13. 版本与变更（摘录）
- v1.3.0：增加完整统计分析、导航优化、数据准确性修复、Electron 缓存权限等优化（详见仓库更新日志）。

---

### 附录 A：字段建议（家庭服务）
- `service_id`、`patient_id`、`service_type`（物资/心理/探访/随访等）
- `service_date`、`provider`（执行人/社工）、`notes`、`attachments`（可选）

### 附录 B：UI 组件清单（可复用）
- 搜索框（含清空）、下拉筛选（多选）、日期范围选择器、分页器、空态占位、统计卡片组件、图表容器、回钻明细弹窗。

---

> 本文档为“新增页面”所需的**工程实践底稿**。实施过程中，如发现与实际代码结构有差异，以 `src/` 目录实际实现为准；也欢迎在 `docs/` 下提交补充说明与设计决策记录。

