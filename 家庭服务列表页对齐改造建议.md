# 背景
仓库 `enoa2014/windows01` 中：**入住信息列表页/统计页**是由一套“生成式页面管线（router → view-model → renderer）”动态生成，而不是一个静态的 `*.html` 文件。

当前新增的**家庭服务列表页**实现方式与这条管线不一致，导致：
- 组件与样式未复用（Toolbar/Table/Empty/Error/Loading）。
- 状态管理与路由参数解析不统一（分页、排序、筛选、密度切换、url query）。
- 导出、批量操作、权限/字段可见性策略无法沿用。

> 目标：在**不改变现有“生成式页面管线”**的前提下，把“家庭服务列表页”接入同一套路由、状态、渲染与主题系统，做到“看起来一致、用起来一致、维护起来一致”。

---

## 1）接入点对齐（而非创建 html 文件）
### 路由注册（示例）
```ts
// router/register.ts
registerPage({
  name: 'family-services',
  path: '/list/family-services',
  title: '家庭服务列表',
  factory: createListPageFactory('familyServices')
});
```

### 页面工厂
```ts
// pages/factory.ts
export const createListPageFactory = (resource: 'checkins'|'familyServices') => ({
  vm: () => createListViewModel(resource),
  view: (vm) => renderListPage(vm),
});
```

---

## 2）统一 ViewModel
### 资源适配器（真实字段）
```ts
// vm/resources.ts
export const resourceAdapters = {
  checkins: {
    api: '/api/checkins',
    defaultSort: [
      {key:'checkin_date', order:'desc'},
      {key:'created_at', order:'desc'}
    ],
    columns: 'checkins.columns',
    filtersSchema: 'checkins.filters'
  },
  familyServices: {
    api: '/api/family-services',
    defaultSort: [
      {key:'service_date', order:'desc'},
      {key:'created_at', order:'desc'}
    ],
    columns: 'familyServices.columns',
    filtersSchema: 'familyServices.filters'
  }
} as const;
```

---

## 3）列配置中心
```ts
// columns/index.ts
export const columnsConfig = {
  checkins: [
    { key:'child_name', title:'患儿姓名', width:180, fixed:'left' },
    { key:'checkin_date', title:'入住日期', sorter:true },
    { key:'checkout_date', title:'退住日期', sorter:true },
    { key:'room_no', title:'房间号' },
    { key:'notes', title:'备注', ellipsis:true }
  ],
  familyServices: [
    { key:'family_name', title:'家庭名称', width:200, fixed:'left' },
    { key:'service_date', title:'服务日期', sorter:true },
    { key:'service_type', title:'服务类型', filter: 'serviceType' },
    { key:'staff_name', title:'服务人员' },
    { key:'service_location', title:'服务地点' },
    { key:'participant_count', title:'参与人数', align:'right' },
    { key:'service_notes', title:'服务内容', ellipsis:true }
  ]
};
```

---

## 4）筛选配置中心
```ts
// filters/index.ts
export const filtersSchemas = {
  checkins: {
    dateRange: { field:'checkin_date', preset:'last90d' },
    room_no: { type:'select', options:['101','102','103'] }
  },
  familyServices: {
    dateRange: { field:'service_date', preset:'last90d' },
    serviceType: { type:'multi-select', options:['心理支持','物资支持','医疗随访','转介','陪伴'] },
    staff_name: { type:'searchable-select', remote:'/api/staff/options' }
  }
};
```

---

## 5）典型后端响应（真实字段）
```json
{
  "items": [
    {
      "id": 101,
      "family_name": "李家",
      "service_date": "2025-07-08",
      "service_type": "心理支持",
      "staff_name": "张三,王五",
      "service_location": "广西医大一附院",
      "participant_count": 3,
      "service_notes": "家属焦虑，已转介社工跟进"
    }
  ],
  "total": 324
}
```

---

## 6）落地步骤
1. 在 `vm/resources.ts` 增加 `familyServices` 配置。
2. 在 `columns/index.ts` 增加 `familyServices` 字段映射：`family_name, service_date, service_type, staff_name, service_location, participant_count, service_notes`。
3. 在 `filters/index.ts` 增加服务日期、服务类型、服务人员筛选。
4. 在 `router/register.ts` 注册 `family-services` 路由。
5. API `/api/family-services` 返回真实字段，与前端配置保持一致。
6. 确认导出 CSV/打印字段顺序与 `columnsConfig.familyServices` 一致。

