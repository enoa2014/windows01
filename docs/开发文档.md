# 患儿入住信息管理系统 · 开发文档

本项目是基于 Electron + SQLite 的桌面应用，用于导入、管理和分析患儿入住与“小家”家庭服务相关数据，支持 Excel 导入、统计分析、图表展示与数据导出。

本文档面向开发者，涵盖架构、目录结构、开发与调试、数据库设计、IPC 接口、前端模块、常见任务与故障排查。

---

## 1. 技术栈与运行环境

- Electron 28（主进程、渲染进程、Preload 安全桥）
- SQLite3（`sqlite3@^5.1.6`）
- Excel 处理：`xlsx@^0.18.5`
- 配置存储：`electron-store@^8.1.0`
- UI：原生 HTML/CSS + Tailwind CDN + 自定义 Design System + Chart.js 4
- 包装与发布：`electron-builder@^24`
- Node.js：建议使用 Node 18+（与 `node_modules` 当前版本匹配）

安装依赖：

```bash
npm install
```

开发启动（支持 `--dev` 自动打开 DevTools）：

```bash
npm run dev
```

正常启动：

```bash
npm start
``;

打包发布（Windows NSIS 安装包）：

```bash
npm run build-win
```

> 产物默认输出至 `dist/`，应用 ID、图标、NSIS 配置见 `package.json -> build`。

---

## 2. 目录结构

关键目录与文件说明：

```
.
├─ src/
│  ├─ main.js                # Electron 主进程入口（创建窗口、初始化数据库、注册 IPC）
│  ├─ preload.js             # 预加载脚本，暴露安全的 `window.electronAPI`
│  ├─ database/
│  │  └─ DatabaseManager.js  # SQLite 封装、建表、查询、统计
│  ├─ services/
│  │  ├─ ExcelImporter.js                # 通用 Excel 导入器（患者/基本数据）
│  │  ├─ FamilyServiceImporter.js       # 家庭服务 Excel 导入/导出
│  │  ├─ FamilyServiceManager.js        # 家庭服务 CRUD + 统计
│  │  └─ database-optimizer.js          # 数据库优化相关（索引/清理等）
│  ├─ renderer/
│  │  ├─ index.html, family-service.html, dashboard.html, ...
│  │  ├─ js/ (app.js, family-service-app.js, dashboard.js, ...)
│  │  └─ styles/ (medical-design-system.css 等设计系统样式)
│  ├─ config/
│  │  ├─ columns.js           # 列配置
│  │  ├─ filters.js           # 筛选配置与工具
│  │  └─ resources.js         # 资源适配器（api、列、筛选、统计接口）
│  └─ viewmodels/ utils/      # 数据修复、Excel 诊断等工具
├─ database-schema.sql        # 数据库建表与索引（患者/医疗/家庭信息）
├─ package.json               # 脚本、依赖、electron-builder 配置
├─ docs/*.md                  # 项目说明与历史文档
└─ 各类脚本（导入、修复、诊断）与示例 Excel
```

---

## 3. 架构与数据流

- Electron 主进程（`src/main.js`）
  - 创建 `BrowserWindow` 并加载 `renderer/index.html`
  - 初始化数据库（`DatabaseManager.initialize()`）：连接 SQLite、建表、开启外键
  - 注册 IPC 处理器：患者、统计、家庭服务 CRUD/导入导出等
- Preload（`src/preload.js`）
  - 通过 `contextBridge` 暴露受限 API（白名单 IPC channel）到 `window.electronAPI`
- 渲染进程（`src/renderer/*`）
  - 纯前端页面 + JS 控制，调用 `window.electronAPI` 获取/提交数据
  - 使用 `config/` 下的列与筛选配置渲染表格、筛选器与图表
- 服务层（`src/services/*`）
  - Excel 导入/导出、家庭服务统计、业务校验
- 数据层（`src/database/DatabaseManager.js`）
  - 统一的 `run/get/all` Promise 封装
  - 建表、索引、查询聚合统计、去重与插入复合记录

数据流示意：

渲染进程(JS) → preload(window.electronAPI) → 主进程(IPC handler) → DatabaseManager(SQLite)

---

## 4. 数据库存储

- 物理位置：`app.getPath('userData')/patients.db`（运行时自动创建）
- 外键：启用 `PRAGMA foreign_keys = ON`
- 初始化：主进程启动时读取 `database-schema.sql` 创建患者/医疗/家庭等表与索引

已定义的核心表（节选）：

- `persons`：人员主表（去重后的唯一人员，`name`, `id_card` 唯一约束策略）
- `patient_profiles`：患者档案（性别、出生日期、籍贯等）
- `check_in_records`：入住记录（日期、入住人员、治疗安排）
- `medical_info`：医疗信息（医院、诊断、医生、治疗过程、记录日期）
- `family_info`：家庭信息（住址、父母信息、经济情况）

关于家庭服务表：代码中大量引用 `family_service_records`，包含字段：

- `sequence_number` 序号
- `year_month` 年月（按月统计，日期型，通常为当月第一天）
- `family_count` 家庭数
- `residents_count` 入住人数
- `residence_days` 入住天数
- `accommodation_count` 住宿人次
- `care_service_count` 关怀服务人次
- `volunteer_service_count` 志愿服务人次
- `total_service_count` 总服务人次
- `notes` 备注
- `cumulative_residence_days` 累计入住天数
- `cumulative_service_count` 累计服务人次
- `created_at`/`updated_at`

提示：若本地初始库缺少该表，导入/统计相关功能会失败。可在 `database-schema.sql` 中补充对应建表 SQL 或由导入流程前置检查并创建表。

---

## 5. 主要模块说明

### 5.1 DatabaseManager（`src/database/DatabaseManager.js`）

- 连接与初始化：创建数据目录与库文件 → 连接 → 外键 → 建表/索引
- 通用方法：`run(sql, params)`, `get(sql, params)`, `all(sql, params)`
- 去重插入：`findOrCreatePerson(name, idCard)`；插入复合记录：`insertPatientRecord(recordData)`
- 业务查询：
  - 患者列表/检索/详情：`getPatients`, `searchPatients`, `getPatientDetail`
  - 基础/扩展统计：`getStatistics`, `getExtendedStatistics`
  - 年龄段明细：`getAgeGroupPatients(ageRange)`
  - 家庭服务统计：`getFamilyServiceStatistics`, `getFamilyServiceOverviewStats`, `getFamilyServiceStatsByDateRange`

实现要点：
- 多来源表聚合与日期清洗（点号日期如 `2014.3.7` 兼容）
- 统计查询包含 CTE、窗口函数与多表聚合，注意性能与索引

### 5.2 ExcelImporter（`src/services/ExcelImporter.js`）

- 读取 Excel → 结构诊断（`utils/ExcelDiagnostics`）→ 列映射 → 逐行解析 → 调用 `DatabaseManager.insertPatientRecord`
- 列匹配包含多种中文表头关键词，严格优先级避免误判（如“母亲姓名”误匹配患者姓名）

### 5.3 家庭服务（Importer/Manager）

- `FamilyServiceImporter.js`
  - 目标工作表：`家庭服务`
  - 日期序列转换、数字安全解析、事务批量写入
  - 导出：将库中数据转换为友好表头写回 Excel
- `FamilyServiceManager.js`
  - 列表获取（含筛选/分页占位）、详情、创建/更新/删除/批量删除
  - 统计概览：总体、当年、最近 12 个月趋势、年度对比
  - 数据校验：必填项、非负数、逻辑一致性（如有入住人数但家庭数为 0）

### 5.4 渲染进程应用

- `renderer/index.html` + `js/app.js`
  - 主页/列表/详情/统计视图切换；主题系统；搜索、排序、导入
  - 与 `electronAPI` 通信获取患者与统计数据，使用 Chart.js 绘图
- `renderer/family-service.html` + `js/family-service-app.js`
  - 家庭服务列表与概览卡片、筛选（`config/filters.js`）、导出与分页
- 样式系统
  - `styles/medical-design-system.css` 等：变量化配色、阴影、组件态

---

## 6. IPC 接口（主进程 handler）

预加载层白名单参见 `src/preload.js`。常用通道：

- 患者/统计
  - `get-patients`() → 列表
  - `get-patient-detail`(personId) → 详情（profile/family/checkIns/medicalInfo）
  - `search-patients`(query)
  - `get-statistics`(), `get-extended-statistics`()
  - `get-age-group-patients`(ageRange)
  - `import-excel`() → 选择文件并导入通用患者数据
- 家庭服务
  - `family-service:get-records`(filters, pagination)
  - `family-service:get-overview-stats`()
  - `family-service:get-statistics`() / `family-service:get-stats-by-date-range`({ startDate, endDate })
  - `family-service:get-record-by-id`(id)
  - `family-service:create-record`(recordData)
  - `family-service:update-record`(id, updateData)
  - `family-service:delete-record`(id) / `family-service:batch-delete-records`(ids)
  - `family-service:import-excel`() → 选择 Excel（“家庭服务”表）并导入
  - `family-service:export-excel`(filters) → 导出到指定路径
  - `family-service:get-filter-options`() → 返回筛选下拉选项（年份等）

返回结构均为 `Promise`，异常会通过 `throw`/返回失败对象体现，前端需处理错误态与提示。

---

## 7. 配置与前端适配层（`src/config`）

- `resources.js`：按资源（如 `familyServices`）声明默认排序、列配置键、筛选 schema、对应的 IPC API key
- `columns.js`：表格列定义（key、标题、宽度、格式化器等）
- `filters.js`：筛选 schema、预设时间范围、通用筛选工具

前端通过这些配置实现：同一渲染逻辑 + 不同资源/列/筛选的组合。

---

## 8. 开发与调试流程

- 启动调试：`npm run dev`（携带 `--dev`，自动打开 DevTools）
- 数据库位置：见“数据库存储”章节，可用 SQLite 浏览工具查看
- 快速验证：
  1) 主页“导入 Excel”导入患者数据（示例 `test_data.xlsx`）
  2) 打开“家庭服务”页，从菜单导入“家庭服务”工作表 Excel（见导入器注释）
  3) 查看“统计/仪表盘”页图表展示
- UI 迭代：修改 `renderer/styles/*` 与对应 `js/*`，刷新窗口即可

---

## 9. 代码风格与约定

- 保持模块单一职责：主进程仅做窗口/IPC/数据库编排；业务放 `services/`；SQL 封装集中 `DatabaseManager`
- IPC 通道需在 `preload.js` 白名单登记；渲染层通过 `window.electronAPI` 调用
- SQL：尽量参数化占位符，避免拼接；复杂查询使用 CTE 分步计算
- 日期：统一使用 `YYYY-MM-DD` 或月维度使用当月第一天；Excel 序列号需转换
- 命名：数据库字段使用下划线，JS 对象使用驼峰；在 Manager 中提供 snake/camel 转换工具

---

## 10. 测试与脚本

- `npm test`（Jest）挂钩已配置，但当前仓库内以开发/诊断脚本为主（根目录 `test-*.js`, `debug-*.js`, `verify-*.js` 等），尚未系统化单测
- 数据清洗/迁移：`fix-*.js`, `migrate-*.js`, `clean-database.js` 等按需使用（运行前建议备份数据库）

---

## 11. 常见问题（FAQ）与排障

- 启动报“无法初始化数据库”
  - 检查当前用户对 `app.getPath('userData')` 目录的写权限
  - 确认 `database-schema.sql` 可读，且 `DatabaseManager.createTables()` 未抛异常
- 家庭服务导入失败/统计为空
  - 检查是否已创建 `family_service_records` 表（字段见上文）；如缺失请补充建表 SQL
  - 检查 Excel 工作表名称为“家庭服务”，表头行位置与列顺序是否符合导入器约定
- 年龄统计异常
  - 核对 `patient_profiles.birth_date` 的格式（点号分隔与标准日期均支持）
- UI 无法加载 Tailwind/Chart.js（离线环境）
  - 当前通过 CDN 引入，离线需改为本地包或构建脚本引入

---

## 12. 发布与版本

- 版本号来源：`preload.js -> getAppVersion()` 读取 `npm_package_version`
- 构建配置：`package.json -> build`（`appId`、`productName`、`nsis` 可定制）
- Windows 打包：`npm run build-win`（目标 `nsis`）

---

## 13. 后续改进建议

- 将 `family_service_records` 建表语句并入 `database-schema.sql`，避免首次导入失败
- 新增端到端测试与最小单元测试（导入/查询/统计）
- 移除在线 CDN 依赖，改为构建期打包本地静态资源
- 增加数据库迁移系统（版本号 + 迁移脚本）
- 抽象统一的表格/筛选/分页组件，复用到多资源页面

---

如需我补充 ER 图、IPC 数据结构示例或为 `family_service_records` 生成标准建表 SQL，请告诉我你的期望格式。 
